<?php
function genie_encheres_rappels_paiements_objets_dist($time){
 spip_log("1 ",'encheres_cron_test');

$date_actuel= time();

include_spip('inc/utils');

		
// Puis les objets vendu

      $vendu = sql_select('*', 'spip_encheres_objets',array('statut="vendu"',"statut_payement_objet=''","id_acheteur!=0"),'',array("date_vente"));
		 while($v = sql_fetch($vendu)) {

 		 $id_objet = $v['id_objet'];
		 $id_auteur=$v['id_auteur'];
		 $id_article=$v['id_article'];
		 $id_acheteur=$v['id_acheteur']; 
 		 $date_vente = $v['date_vente'];
 		 $envoi_rappels = $v['envoi_rappels'];

 		 $date_vente_jours = date('d-m-Y',strtotime($date_vente));
 		 $date_vente_heures = date('G:i:s',strtotime($date_vente));
   	 	$split_vente_jours = explode("-", $date_vente_jours);
   	 	$split_vente_heures = explode(":", $date_vente_heures);
   		 $date_vente = mktime($split_vente_heures[0], $split_vente_heures[1], $split_vente_heures[2], $split_vente_jours[1], $split_vente_jours[0], $split_vente_jours[2]) ;
 		 $date_difference_vente = ($date_actuel-$date_vente)/86400;

		 // 28 jours sans paiement enregistré 
		 if ($date_difference_vente >= 28 AND $envoi_rappels==24){

			 // on remet le statut on stand_by
			 
			 spip_query("UPDATE spip_encheres_objets SET envoi_rappels='28' WHERE id_objet='$id_objet'");	 
			 spip_log("CRON : update bdd rappel 28: id_objet: $id_objet ",'encheres_cron');

 			// on envoie les mails 
 
 			$acheteur = spip_query( "SELECT * FROM spip_auteurs WHERE id_auteur='$id_acheteur'" );
 				while($data = sql_fetch($acheteur)) {
 				$email_acheteur = $data['email'];
 
 				$envoyer_message_kidonateur = charger_fonction('envoyer_message_kidonateur','inc');
 				$envoyer_message_kidonateur($email_acheteur,'remise_en_vente_vendeur',$id_objet);
						
 				//Mail d'info au webmaster
 				$envoyer_message_webmestre = charger_fonction('envoyer_message_webmestre','inc');
				$envoyer_message_webmestre('rappel_acheteur',$id_objet);
 
 				spip_log("CRON : envoi rappel 28: id_objet: $id_objet ",'encheres_cron');
				
			 }
		}
		 // 21 jours sans paiement enregistré

		 if ($date_difference_vente >= 24 AND $envoi_rappels==16){

			 // on note le rappel dans la bdd 
			 spip_query("UPDATE spip_encheres_objets SET envoi_rappels='24' WHERE id_objet='$id_objet'");
			 spip_log("CRON : update bdd rappel 24: id_objet: $id_objet ",'encheres_cron');

			 // on envoie les mails 

			 $contexte =donnees($id_objet);
			 
			 $envoyer_message_acheteur = charger_fonction('envoyer_message_acheteur','inc');
			 $envoyer_message_acheteur('','rappel_acheteur',$id_objet, $contexte);

			 $envoyer_message_kidonateur = charger_fonction('envoyer_message_kidonateur','inc');
			 $envoyer_message_kidonateur('','rappel_vendeur',$id_objet, $contexte);
			  
					
			 $envoyer_message_asso = charger_fonction('envoyer_message_asso','inc');
			 $envoyer_message_asso('','rappel_asso',$id_objet, $contexte);

			 //Mail d'info au webmaster
			 $envoyer_message_webmestre = charger_fonction('envoyer_message_webmestre','inc');
			 $envoyer_message_webmestre('rappel_acheteur',$id_objet, $contexte);

			 spip_log("CRON : envoi rappel 24: id_objet: $id_objet ",'encheres_cron');
				 
			 }

		 // 15 jours sans paiement enregistré
		 elseif ($date_difference_vente >= 16 AND $envoi_rappels==10){
		 

			 // on note le rappel dans la bdd 
			 spip_query("UPDATE spip_encheres_objets SET envoi_rappels='16' WHERE id_objet='$id_objet'");
			 spip_log("CRON : update bdd rappel 16: id_objet: $id_objet ",'encheres_cron');

			 // on envoie les mails 

			 $contexte =donnees($id_objet);

			 $envoyer_message_acheteur = charger_fonction('envoyer_message_acheteur','inc');
			 $envoyer_message_acheteur('','rappel_acheteur',$id_objet, $contexte);

			 $envoyer_message_kidonateur = charger_fonction('envoyer_message_kidonateur','inc');
			 $envoyer_message_kidonateur('','rappel_vendeur',$id_objet, $contexte);
					
			 $envoyer_message_asso = charger_fonction('envoyer_message_asso','inc');
			 $envoyer_message_asso('','rappel_asso',$id_objet,$contexte);
				
			 //Mail d'info au webmaster
			 $envoyer_message_webmestre = charger_fonction('envoyer_message_webmestre','inc');
			 $envoyer_message_webmestre('rappel_acheteur',$id_objet);

			 spip_log("CRON : envoi rappel 16: id_objet: $id_objet ",'encheres_cron');
				 
			 }

		 // 10 jours sans paiement enregistré
		 elseif ($date_difference_vente >= 10 AND $envoi_rappels==''){
		 		  spip_log("2",'encheres_cron_test');
			 // on note le rappel dans la bdd 
			 spip_query("UPDATE spip_encheres_objets SET envoi_rappels='10' WHERE id_objet='$id_objet'");
			 spip_log("CRON : update bdd rappel 10: id_objet: $id_objet - aut $id_acheteur",'encheres_cron');

			 // on envoie les mails 
			  $contexte =donnees($id_objet);

			$envoyer_message_acheteur = charger_fonction('envoyer_message_acheteur','inc');
			$envoyer_message_acheteur('','rappel_acheteur',$id_objet,$contexte);
 	
 			$envoyer_message_kidonateur = charger_fonction('envoyer_message_kidonateur','inc');
 			$envoyer_message_kidonateur('','rappel_vendeur',$id_objet,$contexte);
							
			$envoyer_message_asso = charger_fonction('envoyer_message_asso','inc');
			$envoyer_message_asso('','rappel_asso','',$contexte);


	
			spip_log("CRON : envoi rappel 10: id_objet: $id_objet ",'encheres_cron');
		 };
	 
	 
	}
	
}
	

function donnees($id_objet){
	include_spip('inc/encheresmail_fonctions');		
	
	// Les infos de l'objet
	$objet=sql_fetsel('*','spip_encheres_objets',array('id_objet='.sql_quote($id_objet)));
	
	// Les infos acheteur
	$acheteur= requete_auteurs_elargis(array('id_auteur='.sql_quote($objet['id_acheteur'])));
	
	//les infos kidonateur
	$kidonateur = requete_auteurs_elargis(array('id_auteur='.sql_quote($objet['id_auteur'])),'compte_bancaire,bic');
			
	// les infos projets	
						
	$artobjet=sql_fetsel('*','spip_articles',array('id_article='.sql_quote($objet['id_article'])));
					
	$projet=sql_fetsel('*','spip_rubriques',array('id_rubrique='.sql_quote($artobjet['id_rubrique'])));				
							
	// Les infos de l'association
	
	$asso = requete_auteurs_elargis(array('id_auteur='.sql_quote($projet['id_auteur'])));
	
	if(lire_config('encheres/super_asso')) {
		$datas=array(
			'asso'=>$asso,
			'projet'=>$projet
			);

		$donnees =donnees_superasso($datas);	
		$asso=$donnees['asso'];
		$projet=$donnees['projet'];	
		}
	
	$contexte=array(
			'objet'=>$objet,
			'projet'=>$projet,
			'asso'=>$asso,
			'artobjet'=>$artobjet,	
			'acheteur'=>$acheteur,	
			'kidonateur'=>$kidonateur,
			'commune'=>'rien',	
			'pays_kidonateur'=>'rien',	
			'id_mot_article'=>'rien',	
			);	

return $contexte;

}
?>