<?php

/* @annotation: Charge les valeurs par défaut pour le fomulaire editer objet */
if (!defined("_ECRIRE_INC_VERSION")) return;
function formulaires_activation_rubrique_charger_dist($id_rubrique){
	$valeurs = array(
		'id_rubrique'=>$id_rubrique,
		'id_rub_mod'=>'',
		'rubrique_projet'=>lire_config('encheres/rubrique_projets'));
	return $valeurs;
	
	
}

/* @annotation: Validation des champs obligatoires */
function formulaires_activation_rubrique_verifier_dist(){
	$sans_article=_request('sans_article');
	$erreurs = array();
	
	// si articles/objets attaché il faut dire quoi faire avec eux
	if(!$sans_article){
		foreach(array('id_rub_mod') as $obligatoire)
			if (!_request($obligatoire)) $erreurs[$obligatoire] = 'Ce champ est obligatoire';
		}
		
	if (count($erreurs))
		$erreurs['message_erreur'] = 'Votre saisie contient des erreurs !';
	return $erreurs;
}


/* @annotation: Actualisation de la base de donnée */
function formulaires_activation_rubrique_traiter_dist($id_rubrique){
	$id_rub_mod= _request('id_rub_mod');
	$desactiver= _request('desactiver');
	
	// Si on désactive
	if($desactiver)	{
	
		// on actualise la rubrique
		$exp =array('desactiver' =>'oui');
		sql_updateq ('spip_rubriques', $exp,'id_rubrique='.$id_rubrique);

		
		// on déplace les articles si les objets attaché ne sont pas vendus		
		if($id_rub_mod){
			//O prépare les donées
			
			// les articles de la rubrique
			$sql=sql_select('id_article','spip_articles','id_rubrique='.sql_quote($id_rubrique));
			$articles=array();
			while($row=sql_fetch($sql)){
				$articles[]=$row['id_article'];
			}
			
			$articles_rubrique=$articles;
			$articles=implode(', ',$articles);
			
			// Les objets vendus de la rubrique
			$objets_vendus=sql_select('id_article,id_objet','spip_encheres_objets','statut IN ("vente_termine","vendu") AND id_article IN ('.$articles.')');
			
			$articles_vendus =array();
			$articles_objets_vendus =array();	
			while($row=sql_fetch($objets_vendus)){
				$articles_vendus[]=$row['id_article'];
				$articles_objets_vendus[$row['id_article']][]=$row['id_objet'];				
				}	
			$articles_vendus_unique=array_unique($articles_vendus);	
			
			//echo serialize($articles_vendus_unique).'<br/>';
			//echo serialize($articles_objets_vendus).'<br/>';			
			
			// Les objets invendus de la rubrique			
			$objets_invendus=sql_select('id_article','spip_encheres_objets','statut NOT IN ("vente_termine","vendu") AND id_article IN ('.$articles.')');			
		
			$articles_invendus =array();	
			while($row=sql_fetch($objets_invendus)){
				$articles_invendus[]=$row['id_article'];
				}	
			$articles_invendus_unique = array_unique($articles_invendus) ;	
			//echo serialize($articles_invendus_unique);
			
			//Les articles qui ne seront transférés car le ou les objets attaché(s) sont tous vendus	
			$articles_a_garder= array_diff($articles_vendus_unique, $articles_invendus_unique);	
			
			// Les articles qui contiennet desobjets vendus et invendus et il faut donc faire un copei dans la rubrique actuel pour y attacher les objets vendus
			$articles_a_copier = array_intersect($articles_vendus_unique, $articles_invendus_unique);
					
			//echo 'a garder'.serialize($articles_a_garder).' articles a copier'. serialize($articles_a_copier) ;	
					
			$exp =array('id_rubrique' => $id_rub_mod);	
			
			// Si il y a des objets invendus
			if ($articles_vendus){
				//On copie si il faut
				if($articles_a_copier){
					foreach($articles_a_copier AS $id_article){
						//on le copies ans la rubrique
						$valeurs = sql_fetsel('*','spip_articles','id_article='.$id_article);
						$valeurs['id_article']='';
						$id_art=sql_insertq('spip_articles',$valeurs);
						
						//puis on y attache les objet vendus correspondants
						$objets = implode(', ',$articles_objets_vendus[$id_article]);
						sql_updateq('spip_encheres_objets',array('id_article'=>$id_art),'id_objet IN ('.$objets .')');
						}
					}
				// Puis on transfère les articles à l'exceptions des articles qui contiennet uniquement des objets vendus	
				if($articles_a_garder){
					foreach($articles_rubrique as $id_article){
						 sql_updateq ('spip_articles', $exp,'id_article NOT IN ('.implode(', ',$articles_a_garder).') AND id_rubrique='.$id_rubrique);
						}
					}
				else sql_updateq ('spip_articles', $exp,'id_rubrique='.$id_rubrique);
				}
			// Si il n'y pas d'objets invendus on transfère tout
			else{
				//echo 'non_vendus';
				sql_updateq ('spip_articles', $exp,'id_article IN ('.$articles.')');
				}
			}
			//On adapte le statut popur des rubriaues qui étaient vident auparament
			$exp =array('statut' => 'publie');			
			sql_updateq ('spip_rubriques', $exp,'id_rubrique='.$id_rub_mod);	
		}
	// Si on active
	else{
		// on actualise la rubrique
		$exp =array('desactiver' =>'');
		sql_updateq ('spip_rubriques', $exp,'id_rubrique='.sql_quote($id_rubrique));	
		}		
}
?>